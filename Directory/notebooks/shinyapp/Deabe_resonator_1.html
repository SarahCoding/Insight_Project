<html>

<head>
<title>Title</title>
</head>

<body>

<p>This is an R HTML document. When you click the <b>Knit HTML</b> button a web page will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:</p>

<!--begin.rcode
library(dplyr)
library(leaflet)
library(maps)
library(Rcpp)
library(rsconnect)
library(shiny)
library(tidyr)
  
#rsconnect::setAccountInfo(name='sarahcoding', token='0FBD24670D53516D9A94DA892DEF8FBC', secret='zVjk5Bc2xNliBrOialxeh/XENbgIjTo8nVvwUOtM')
#rsconnect::deployApp('C:/Users/sarah/Dropbox/Insight_fellowship/Project/Directory/notebooks/shinyapp/Debate_resonator_deploy.Rhtml')

#data pull and clean
setwd("C:/Users/sarah/Dropbox/Insight_fellowship/Project/Directory/data/cleaned")
tweets_Debate_20191220=read.csv("Tweets_Debate_20191220.csv")
missing=as.data.frame(read.csv("missing_cleaned_values_debate_20191220.csv")[1:3])
main_data=tweets_Debate_20191220[,c("State", "Candidate", "cos")]
data_full=rbind(missing, main_data)
dataclean=as.data.frame(summarise_at(group_by(data_full,Candidate, State),vars(cos),funs(mean(.,na.rm=TRUE))))
dataclean$norm_cos=signif(((dataclean$cos)-min(dataclean$cos))/(max(dataclean$cos)-min(dataclean$cos))*100, 2)
Candidate2=as.data.frame(gsub( "_tw", "", as.character(dataclean$Candidate)))#one time fix
dataclean$Candidate <- Candidate2 #one time fix
#add geographical information for leaflet below
#Col Flo Mic Min Nev New Nor Ohi Pen Vir Wis 
dataclean$lng[dataclean$State=="Col"]=-105.358887
dataclean$lat[dataclean$State=="Col"]=39.113014
dataclean$lng[dataclean$State=="Flo"]=-81.760254
dataclean$lat[dataclean$State=="Flo"]=27.994402
dataclean$lng[dataclean$State=="Mic"]=-84.506836
dataclean$lat[dataclean$State=="Mic"]=44.182205
dataclean$lng[dataclean$State=="Min"]=-94.636230
dataclean$lat[dataclean$State=="Min"]=46.392410
dataclean$lng[dataclean$State=="Nev"]=-117.224121
dataclean$lat[dataclean$State=="Nev"]=39.876019
dataclean$lng[dataclean$State=="New"]=-71.500000
dataclean$lat[dataclean$State=="New"]=44.000000
dataclean$lng[dataclean$State=="Nor"]=-80.793457
dataclean$lat[dataclean$State=="Nor"]=35.782169
dataclean$lng[dataclean$State=="Ohi"]=-82.9071
dataclean$lat[dataclean$State=="Ohi"]=40.4173
dataclean$lng[dataclean$State=="Pen"]=-77.1945
dataclean$lat[dataclean$State=="Pen"]=41.2033
dataclean$lng[dataclean$State=="Vir"]=-78.6569
dataclean$lat[dataclean$State=="Vir"]=37.4316
dataclean$lng[dataclean$State=="Wis"]=-89.500000
dataclean$lat[dataclean$State=="Wis"]=44.500000
#States=as.data.frame(unique(dataclean$State))
lng2=as.data.frame(unique(dataclean$lng))
lat2=as.data.frame(unique(dataclean$lat))


##webapp
ui = fluidPage(
  titlePanel("Debate Reactor"),
  sidebarLayout(
  sidebarPanel(
    helpText("Create maps ranking twitter reaction by state following debates."),
    selectInput("candidate",
                label = "Choose a candidate to display",
                choices = c( "Joe Biden"="Biden", 
                            "Pete Buttigieg"="Buttigieg",
                            "Amy Klobuchar"="Klobuchar", 
                            "Bernie Sanders"="Sanders",
                            "Tom Steyer"="Steyer",
                            "Elizabeth Warren"="Warren",
                            "Andrew Yang"="Yang"),
                selected = "Candidate"),
  dateInput("date", label = h3("Date of debate"), value = "2019-12-20")),
  hr()),
  mainPanel(
    textOutput("candidate_selected"),
    leafletOutput("map"),
    p()
  )
)

server <- function(input, output) {
  
  output$candidate_selected <- renderText({ 
    paste("Twitter engagement for", input$candidate, "for debate on",
          input$date, "Topics include RACISM and GUN VIOLENCE.")
  })
  output$map <- renderLeaflet({
    score <- rank(as.data.frame(subset(dataclean$norm_cos, dataclean$Candidate==input$candidate)))
    #score <-rank(as.data.frame(subset(dataclean$norm_cos, dataclean$Candidate=="Biden")))
    df<-cbind(score, lng2, lat2)
    colnames(df)=c( "score", "lng", "lat")
    leaflet(df,width = 400, height = 400 ) %>% addTiles() %>%
      addCircles(lng = ~lng, lat = ~lat, weight = 1,
                 radius = ~score * 30000, popup = paste( "Debate resonated #",data=rank(-(subset(dataclean$norm_cos,
                                           dataclean$Candidate==input$candidate)), ties.method = "last"),
                                           "among 11 swing states" )
                
      )
    
  })
}

shinyApp(ui, server)

  end.rcode-->


</body>
</html>
